"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.runSearch=runSearch;var _promises=require("fs/promises"),_path=require("path"),_axios=_interopRequireDefault(require("axios")),_settings=require("../services/settings.server");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ownKeys(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),t.push.apply(t,n)}return t}function _objectSpread(r){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(t,!0).forEach(function(e){_defineProperty(r,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ownKeys(t).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(t,e))})}return r}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}var DATA_DIR=(0,_path.join)(process.cwd(),"app","data"),SEARCH_RESULTS_FILE=(0,_path.join)(DATA_DIR,"search_results.json"),SHORTCUTS_FILE=(0,_path.join)(DATA_DIR,"shortcuts.json"),SHOPIFY_LOCATION_ID="gid://shopify/Location/102699630920",VENDUS_URL="https://www.vendus.pt/ws/v1.1/products",RETRY_CONFIG={maxRetries:3,baseDelay:1e3,maxDelay:8e3,backoffFactor:2},sleep=function(r){return new Promise(function(e){return setTimeout(e,r)})};function getRetryDelay(e){var r=RETRY_CONFIG.baseDelay*Math.pow(RETRY_CONFIG.backoffFactor,e-1);return Math.min(r,RETRY_CONFIG.maxDelay)}function fetchVendusDataWithRetries(r,t){var n,a,o,s=arguments;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=2<s.length&&void 0!==s[2]?s[2]:1,e.prev=1,e.next=4,regeneratorRuntime.awrap(_axios.default.get(r,{headers:{Accept:"application/json",Authorization:"Bearer ".concat(t)},timeout:1e4}));case 4:return a=e.sent,e.abrupt("return",a.data);case 8:if(e.prev=8,e.t0=e.catch(1),console.error("Vendus API call failed (Attempt ".concat(n,"):"),e.t0.message),n<RETRY_CONFIG.maxRetries)return o=getRetryDelay(n),console.log("Retrying in ".concat(o,"ms...")),e.next=16,regeneratorRuntime.awrap(sleep(o));e.next=19;break;case 16:return e.abrupt("return",fetchVendusDataWithRetries(r,t,n+1));case 19:throw new Error("Failed to fetch from Vendus API after ".concat(RETRY_CONFIG.maxRetries," attempts: ").concat(e.t0.message));case 20:case"end":return e.stop()}},null,null,[[1,8]])}function runSearch(r){var t,n,a,o,s,c,u,i,p,l,d,f,h,g,_,R,v,b,m,w,S;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap((0,_promises.mkdir)(DATA_DIR,{recursive:!0}));case 3:return t={searchDate:(new Date).toISOString(),totalSearched:0,totalFound:0,found:{},notFound:[]},e.prev=4,e.next=7,regeneratorRuntime.awrap((0,_promises.readFile)(SEARCH_RESULTS_FILE,"utf8"));case 7:n=e.sent,t=JSON.parse(n),e.next=19;break;case 11:if(e.prev=11,e.t0=e.catch(4),"ENOENT"!==e.t0.code){e.next=17;break}console.log("search_results.json not found, creating new one."),e.next=19;break;case 17:return console.error("Failed to read search_results.json:",e.t0),e.abrupt("return",{success:!1,error:"Failed to load search results file: ".concat(e.t0.message)});case 19:return a=new Set(r),t.found&&Object.keys(t.found).forEach(function(e){return a.add(e)}),t.totalSearched=a.size,e.next=24,regeneratorRuntime.awrap((0,_settings.getVendusApi)());case 24:o=e.sent,s=o.token,c=[],u=new Set,p=!(i=!0),l=void 0,e.prev=31,d=a[Symbol.iterator]();case 33:if(i=(f=d.next()).done){e.next=50;break}return h=f.value,e.prev=35,console.log("🔍 Searching for product with reference: ".concat(h)),e.next=39,regeneratorRuntime.awrap(fetchVendusDataWithRetries("".concat(VENDUS_URL,"?ref=").concat(encodeURIComponent(h)),s));case 39:(g=e.sent)&&g.data&&0<g.data.length?(_=g.data[0],c.push(_objectSpread({reference:h},_)),console.log("   ✅ Found product: ".concat(_.title," (").concat(_.reference,")"))):console.log("   ❌ Product with reference '".concat(h,"' not found in Vendus.")),e.next=47;break;case 43:e.prev=43,e.t1=e.catch(35),console.error("❌ Error fetching product '".concat(h,"' from Vendus:"),e.t1.message),t.notFound.push(h);case 47:i=!0,e.next=33;break;case 50:e.next=56;break;case 52:e.prev=52,e.t2=e.catch(31),p=!0,l=e.t2;case 56:e.prev=56,e.prev=57,i||null==d.return||d.return();case 59:if(e.prev=59,p)throw l;e.next=62;break;case 62:return e.finish(59);case 63:return e.finish(56);case 64:for(t.found={},v=!(R=!0),b=void 0,e.prev=68,m=function(){var r=S.value,e=c.find(function(e){return e.reference===r});e?(t.found[r]={productData:e,page:e.page,position:c.indexOf(e)+1},u.add(r)):t.notFound.push(r)},w=r[Symbol.iterator]();!(R=(S=w.next()).done);R=!0)m();e.next=77;break;case 73:e.prev=73,e.t3=e.catch(68),v=!0,b=e.t3;case 77:e.prev=77,e.prev=78,R||null==w.return||w.return();case 80:if(e.prev=80,v)throw b;e.next=83;break;case 83:return e.finish(80);case 84:return e.finish(77);case 85:return t.totalFound=u.size,t.searchDate=(new Date).toISOString(),e.prev=87,e.next=90,regeneratorRuntime.awrap((0,_promises.writeFile)(SEARCH_RESULTS_FILE,JSON.stringify(t,null,2),"utf8"));case 90:console.log("✅ Updated search_results.json with refreshed Vendus data."),e.next=97;break;case 93:return e.prev=93,e.t4=e.catch(87),console.error("❌ Failed to write updated search_results.json:",e.t4),e.abrupt("return",{success:!1,error:"Failed to save updated search results file: ".concat(e.t4.message),filePath:SEARCH_RESULTS_FILE});case 97:return e.abrupt("return",{success:!0,searchResults:t,message:"Search completed. Found ".concat(t.totalFound," of ").concat(t.totalSearched," references.")});case 100:return e.prev=100,e.t5=e.catch(0),console.error("Top-level error in runSearch:",e.t5),e.abrupt("return",{success:!1,error:"An unexpected error occurred during search: ".concat(e.t5.message)});case 104:case"end":return e.stop()}},null,null,[[0,100],[4,11],[31,52,56,64],[35,43],[57,,59,63],[68,73,77,85],[78,,80,84],[87,93]])}
//# sourceMappingURL=products.min.js.map
