"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getServerSyncStatus=getServerSyncStatus,exports.startServerSyncJob=startServerSyncJob,exports.stopServerSyncJob=stopServerSyncJob,exports.updateSyncInterval=updateSyncInterval,exports.performManualSync=performManualSync,exports.getSyncStatistics=getSyncStatistics,exports.clearSyncErrors=clearSyncErrors,exports._syncJobState=void 0;var _productSyncServer=require("../services/productSync.server.js");function ownKeys(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),t.push.apply(t,n)}return t}function _objectSpread(r){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(t,!0).forEach(function(e){_defineProperty(r,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ownKeys(t).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(t,e))})}return r}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}var syncJobState={isRunning:!1,intervalId:null,lastServerSync:null,serverSyncCount:0,syncInterval:3e4,errors:[],authPayload:null};function getServerSyncStatus(){return{isRunning:syncJobState.isRunning,lastServerSync:syncJobState.lastServerSync,serverSyncCount:syncJobState.serverSyncCount,syncInterval:syncJobState.syncInterval,errors:syncJobState.errors.slice(-5)}}function performSync(r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("🔄 Starting server-side sync job..."),e.next=4,regeneratorRuntime.awrap((0,_productSyncServer.syncProductsWithShopify)(r));case 4:return t=e.sent,syncJobState.lastServerSync=(new Date).toISOString(),syncJobState.serverSyncCount++,t.success?(console.log("✅ Server sync completed successfully:",t.message),0<syncJobState.errors.length&&(syncJobState.errors=[])):(console.error("❌ Server sync failed:",t.error),syncJobState.errors.push({timestamp:(new Date).toISOString(),error:t.error,type:"sync_failure"}),10<syncJobState.errors.length&&(syncJobState.errors=syncJobState.errors.slice(-10))),e.abrupt("return",t);case 11:return e.prev=11,e.t0=e.catch(0),console.error("💥 Fatal error in server sync:",e.t0),syncJobState.errors.push({timestamp:(new Date).toISOString(),error:e.t0.message,type:"fatal_error"}),e.abrupt("return",{success:!1,error:"Fatal sync error: ".concat(e.t0.message),createdProducts:[],updatedProducts:[],errors:[]});case 16:case"end":return e.stop()}},null,null,[[0,11]])}function startServerSyncJob(r){var t,n,s=arguments;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return t=1<s.length&&void 0!==s[1]?s[1]:3e4,e.prev=1,syncJobState.isRunning&&(console.log("🛑 Stopping existing sync job before starting new one..."),stopServerSyncJob()),syncJobState.authPayload=r,syncJobState.syncInterval=t,console.log("🚀 Starting server-side sync job with ".concat(t,"ms interval...")),e.next=8,regeneratorRuntime.awrap(performSync(r));case 8:return n=e.sent,syncJobState.intervalId=setInterval(function(){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(syncJobState.isRunning&&syncJobState.authPayload)return e.next=3,regeneratorRuntime.awrap(performSync(syncJobState.authPayload));e.next=3;break;case 3:case"end":return e.stop()}})},t),syncJobState.isRunning=!0,console.log("✅ Server-side sync job started successfully"),e.abrupt("return",{success:!0,message:"Server sync job started with ".concat(t,"ms interval"),initialSyncResult:n,status:getServerSyncStatus()});case 15:return e.prev=15,e.t0=e.catch(1),console.error("❌ Failed to start server sync job:",e.t0),syncJobState.isRunning=!1,syncJobState.authPayload=null,syncJobState.intervalId&&(clearInterval(syncJobState.intervalId),syncJobState.intervalId=null),e.abrupt("return",{success:!1,message:"Failed to start server sync job: ".concat(e.t0.message),error:e.t0.message});case 22:case"end":return e.stop()}},null,null,[[1,15]])}function stopServerSyncJob(){try{return syncJobState.isRunning?(console.log("🛑 Stopping server-side sync job..."),syncJobState.intervalId&&(clearInterval(syncJobState.intervalId),syncJobState.intervalId=null),syncJobState.isRunning=!1,syncJobState.authPayload=null,console.log("✅ Server-side sync job stopped successfully"),{success:!0,message:"Server sync job stopped successfully",status:getServerSyncStatus()}):(console.log("⏸️ Server sync job is not running"),{success:!0,message:"Server sync job was not running",status:getServerSyncStatus()})}catch(e){return console.error("❌ Error stopping server sync job:",e),syncJobState.isRunning=!1,syncJobState.authPayload=null,syncJobState.intervalId=null,{success:!1,message:"Error stopping server sync job: ".concat(e.message),error:e.message}}}function updateSyncInterval(e){try{return syncJobState.isRunning?(console.log("⏱️ Updating sync interval to ".concat(e,"ms...")),syncJobState.intervalId&&clearInterval(syncJobState.intervalId),syncJobState.syncInterval=e,syncJobState.intervalId=setInterval(function(){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(syncJobState.isRunning&&syncJobState.authPayload)return e.next=3,regeneratorRuntime.awrap(performSync(syncJobState.authPayload));e.next=3;break;case 3:case"end":return e.stop()}})},e),console.log("✅ Sync interval updated successfully"),{success:!0,message:"Sync interval updated to ".concat(e,"ms"),status:getServerSyncStatus()}):{success:!1,message:"Cannot update interval - sync job is not running"}}catch(e){return console.error("❌ Error updating sync interval:",e),{success:!1,message:"Error updating sync interval: ".concat(e.message),error:e.message}}}function performManualSync(r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("🔧 Performing manual sync..."),e.next=4,regeneratorRuntime.awrap((0,_productSyncServer.syncProductsWithShopify)(r));case 4:return t=e.sent,console.log("✅ Manual sync completed"),e.abrupt("return",{success:!0,message:"Manual sync completed",syncResult:t,status:getServerSyncStatus()});case 9:return e.prev=9,e.t0=e.catch(0),console.error("❌ Manual sync failed:",e.t0),e.abrupt("return",{success:!1,message:"Manual sync failed: ".concat(e.t0.message),error:e.t0.message});case 13:case"end":return e.stop()}},null,null,[[0,9]])}function getSyncStatistics(){return _objectSpread({},getServerSyncStatus(),{uptime:syncJobState.isRunning?Date.now()-new Date(syncJobState.lastServerSync||Date.now()).getTime():0,nextSyncIn:syncJobState.isRunning?syncJobState.syncInterval:null,healthStatus:0<syncJobState.errors.length?"warning":"healthy",recentErrors:syncJobState.errors.slice(-3)})}function clearSyncErrors(){try{var e=syncJobState.errors.length;return syncJobState.errors=[],console.log("🧹 Cleared ".concat(e," sync errors")),{success:!0,message:"Cleared ".concat(e," sync errors"),status:getServerSyncStatus()}}catch(e){return console.error("❌ Error clearing sync errors:",e),{success:!1,message:"Error clearing sync errors: ".concat(e.message),error:e.message}}}exports._syncJobState=syncJobState,process.on("SIGTERM",function(){console.log("📴 Received SIGTERM, stopping sync job..."),stopServerSyncJob()}),process.on("SIGINT",function(){console.log("📴 Received SIGINT, stopping sync job..."),stopServerSyncJob()});
//# sourceMappingURL=syncManager.server.min.js.map
