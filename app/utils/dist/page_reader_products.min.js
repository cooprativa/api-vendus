"use strict";var _axios=_interopRequireDefault(require("axios")),_promises=_interopRequireDefault(require("fs/promises")),_path=require("path");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ownKeys(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),t.push.apply(t,n)}return t}function _objectSpread(r){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(t,!0).forEach(function(e){_defineProperty(r,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ownKeys(t).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(t,e))})}return r}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}require("dotenv/config");var API_KEY=process.env.VENDUS_API_KEY,URL="https://www.vendus.pt/ws/v1.1/products",DATA_DIR=(0,_path.join)(process.cwd(),"app","data"),SEARCH_RESULTS_FILE=(0,_path.join)(DATA_DIR,"search_results.json"),apiClient=_axios.default.create({auth:{username:API_KEY,password:""},timeout:15e3,maxRedirects:0,headers:{Accept:"application/json","User-Agent":"Node.js API Client",Connection:"keep-alive"}}),RETRY_CONFIG={maxRetries:3,baseDelay:1e3,maxDelay:8e3,backoffFactor:2},sleep=function(r){return new Promise(function(e){return setTimeout(e,r)})};function loadSearchResultsFromFile(r){var t,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(_promises.default.readFile(r,"utf8"));case 3:return t=e.sent,!(n=JSON.parse(t)).found||n.found instanceof Map?n.found||(n.found=new Map):n.found=new Map(Object.entries(n.found)),e.abrupt("return",n);case 9:return e.prev=9,e.t0=e.catch(0),"ENOENT"===e.t0.code?console.log("File not found: ".concat(r,". Returning empty results.")):console.error("Error reading or parsing search results file ".concat(r,":"),e.t0),e.abrupt("return",{searchDate:(new Date).toISOString(),totalSearched:0,totalFound:0,found:new Map,notFound:[]});case 13:case"end":return e.stop()}},null,null,[[0,9]])}function saveSearchResultsToFile(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(_promises.default.mkdir((0,_path.join)(r,".."),{recursive:!0}));case 3:return(n=_objectSpread({},t)).found instanceof Map&&(n.found=Object.fromEntries(n.found)),e.next=7,regeneratorRuntime.awrap(_promises.default.writeFile(r,JSON.stringify(n,null,2),"utf8"));case 7:console.log("Results saved to ".concat(r)),e.next=14;break;case 10:throw e.prev=10,e.t0=e.catch(0),console.error("Error saving search results to file ".concat(r,":"),e.t0),e.t0;case 14:case"end":return e.stop()}},null,null,[[0,10]])}function fetchPageFromVendus(r){var t,n,a,o=arguments;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=1<o.length&&void 0!==o[1]?o[1]:0,API_KEY){e.next=3;break}return e.abrupt("return",{error:"Vendus API Key not available. Cannot fetch Vendus data."});case 3:return e.prev=3,console.log("Fetching Vendus products: Page ".concat(r,", Attempt ").concat(t+1)),e.next=7,regeneratorRuntime.awrap(apiClient.get(URL,{params:{page:r}}));case 7:return n=e.sent,e.abrupt("return",{data:n.data.data});case 11:if(e.prev=11,e.t0=e.catch(3),t<RETRY_CONFIG.maxRetries)return a=Math.min(RETRY_CONFIG.baseDelay*Math.pow(RETRY_CONFIG.backoffFactor,t),RETRY_CONFIG.maxDelay),console.warn("Failed to fetch page ".concat(r,". Retrying in ").concat(a,"ms... (Attempt ").concat(t+1,"/").concat(RETRY_CONFIG.maxRetries,")")),e.next=18,regeneratorRuntime.awrap(sleep(a));e.next=19;break;case 18:return e.abrupt("return",fetchPageFromVendus(r,t+1));case 19:return console.error("Error fetching Vendus products page ".concat(r," after ").concat(RETRY_CONFIG.maxRetries," attempts:"),e.t0.message),e.t0.response?(console.error("Response data:",e.t0.response.data),console.error("Response status:",e.t0.response.status),console.error("Response headers:",e.t0.response.headers)):e.t0.request&&console.error("No response received:",e.t0.request),e.abrupt("return",{error:e.t0.message});case 22:case"end":return e.stop()}},null,null,[[3,11]])}function updateProductsFromKnownPages(t,r){var n,a,o,s,c,u,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:n=new Map,a=new Set(t.keys()),o=0,s=1;case 4:if(s<=r)return console.log("Processing Vendus page ".concat(s," for product updates...")),e.next=8,regeneratorRuntime.awrap(fetchPageFromVendus(s));e.next=27;break;case 8:if(c=e.sent,u=c.data,i=c.error)return console.error("Skipping page ".concat(s," due to error: ").concat(i)),e.abrupt("continue",24);e.next=14;break;case 14:if(u&&0!==u.length){e.next=17;break}return console.log("No more products found on page ".concat(s,". Ending search.")),e.abrupt("break",27);case 17:if(o+=u.length,u.forEach(function(e){var r=e.reference;t.has(r)&&(n.set(r,e),a.delete(r),console.log("✅ Found and updated product: ".concat(r)))}),0===a.size)return console.log("All specified products found. Ending search early."),e.abrupt("break",27);e.next=22;break;case 22:return e.next=24,regeneratorRuntime.awrap(sleep(200));case 24:s++,e.next=4;break;case 27:return e.abrupt("return",{found:n,notFound:a,totalSearched:o});case 28:case"end":return e.stop()}})}function executeProductUpdate(){var r,t,n,a,o,s,c,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("Starting the product update process in page_reader_products.js..."),API_KEY||(console.error("❌ Vendus API Key is not set. Please ensure VENDUS_API_KEY environment variable is configured."),process.exit(1)),e.prev=2,e.next=5,regeneratorRuntime.awrap(_promises.default.mkdir(DATA_DIR,{recursive:!0}));case 5:return e.next=7,regeneratorRuntime.awrap(loadSearchResultsFromFile(SEARCH_RESULTS_FILE));case 7:if(r=e.sent,0===(t=r.found||new Map).size)return console.log("ℹ️ No product references found in 'search_results.json' to update from Vendus. No Vendus API search will be performed."),e.abrupt("return");e.next=12;break;case 12:return e.next=14,regeneratorRuntime.awrap(updateProductsFromKnownPages(t,10));case 14:return n=e.sent,a=n.found,o=n.notFound,s=n.totalSearched,c={},a.forEach(function(e,r){c[r]=e}),u={searchDate:(new Date).toISOString(),totalSearched:s,totalFound:a.size,found:c,notFound:Array.from(o)},e.next=23,regeneratorRuntime.awrap(saveSearchResultsToFile(SEARCH_RESULTS_FILE,u));case 23:console.log("\n🎉 Vendus product data update completed and results saved to search_results.json!"),e.next=30;break;case 26:e.prev=26,e.t0=e.catch(2),console.error("❌ Vendus update process failed:",e.t0.message),process.exit(1);case 30:case"end":return e.stop()}},null,null,[[2,26]])}executeProductUpdate();
//# sourceMappingURL=page_reader_products.min.js.map
